{% extends "adserver/reports/base.html" %}
{% load humanize %}
{% load i18n %}


{% block title %}{% trans 'Flight Report' %} - {{ flight }}{% endblock %}


{% block heading %}{% blocktrans %}Flight Report for {{ flight }}{% endblocktrans %}{% endblock heading %}


{% block breadcrumbs %}
  {{ block.super }}
  <li class="breadcrumb-item"><a href="{% url 'advertiser_report' advertiser.slug %}">{{ advertiser.name }}</a></li>
  <li class="breadcrumb-item active">{{ flight }}</li>
{% endblock breadcrumbs %}


{% block summary %}

  <section>

    <h3>
      <a href="{% url 'flight_detail' advertiser.slug flight.slug %}">{% trans 'Flight' %}: {{ flight.name }}</a>
      {% if not flight.live %}<span class="fa fa-eye-slash fa-fw text-muted" aria-hidden="true" data-toggle="tooltip" title="" data-original-title="{% trans 'This flight is disabled' %}"></span>{% endif %}
    </h3>

    {% include "adserver/includes/flight-metadata.html" %}

    <p>
      <a href="{% url 'flight_detail' advertiser.slug flight.slug %}" class="btn btn-sm btn-outline-secondary" role="button" aria-pressed="true">
        <span class="fa fa-cog mr-1" aria-hidden="true"></span>
        <span>{% trans 'Manage flight & ads' %}</span>
      </a>
    </p>
  </section>

  <section class="mt-5">
    <div>
      <div class="row">
        <h2 class="col-md-8">{% trans 'Total results for all ads' %}</h2>

        <aside class="mb-3 col-md-4 text-right">
          <a href="{% url 'flight_report_export' advertiser.slug flight.slug %}?start_date={{ start_date|date:'Y-m-d' }}{% if end_date %}&amp;end_date={{ end_date|date:'Y-m-d' }}{% endif %}" class="btn btn-sm btn-outline-secondary" role="button" aria-pressed="true">
            <span class="fa fa-download mr-1" aria-hidden="true"></span>
            <span>CSV Export</span>
          </a>
        </aside>
      </div>

      <table class="table table-hover">
        <thead>
          <tr>
            <th><strong>{% trans 'Time Period' %}</strong></th>
            <th><strong>{% trans 'Total&nbsp;Views' %}</strong></th>
            <th><strong>{% trans 'Total&nbsp;Clicks' %}</strong></th>
            <th><strong>{% trans 'Total&nbsp;Cost' %}</strong></th>
            <th><strong>{% blocktrans %}Total&nbsp;<abbr title="Click through rate">CTR</abbr>{% endblocktrans %}</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for day in flight_report.days %}
            {% if day.views > 0 or day.clicks > 0 %}
            <tr>
              <td>{{ day.date }}</td>
              <td>{{ day.views|intcomma }}</td>
              <td>{{ day.clicks|intcomma }}</td>
              <td>${{ day.cost|floatformat:2|intcomma }}</td>
              <td>{{ day.ctr|floatformat:3 }}%</td>
            </tr>
            {% endif %}
          {% endfor %}
          <tr>
            <td><strong>{{ start_date|date:"M j, Y" }} - {{ end_date|date:"M j, Y" }}</strong></td>
            <td><strong>{{ total_views|intcomma }}</strong></td>
            <td><strong>{{ total_clicks|intcomma }}</strong></td>
            <td><strong>${{ total_cost|floatformat:2|intcomma }}</strong></td>
            <td><strong>{{ total_ctr|floatformat:3 }}%</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
{% endblock summary %}


{% block report %}
<div>
  <section>

    {% for ad in advertisements %}

      <hr class="my-4">

      <h4>
        <a href="{% url 'advertisement_detail' advertiser.slug flight.slug ad.slug %}">{% trans 'Advertisement' %}: {{ ad.name }}</a>
        {% if not ad.live %}<span class="fa fa-eye-slash fa-fw text-muted" aria-hidden="true" data-toggle="tooltip" title="" data-original-title="{% trans 'This ad is disabled' %}"></span>{% endif %}
      </h4>

      <div class="row">

        {# Show the ad #}
        <div class="col">
          <div class="advertisement-preview">
            <div class="mx-auto">{{ ad.render_ad | safe }}</div>
          </div>
        </div>

        {# Ad metadata #}
        <div class="col">
          <dl>
            {% if not ad.live %}
              <dt>{% trans 'Disabled' %}</dt>
              <dd>{% trans 'This promo is not currently being shown' %}</dd>
            {% endif %}
            <dt>{% trans 'Display' %}</dt>
            <dd>{{ ad.ad_types.all | join:", " }}</dd>
            {% if ad.link %}
              <dt>{% trans 'Click-through link' %}</dt>
              <dd><small><a href="{{ ad.link }}">{{ ad.link|truncatechars:50 }}</a></small></dd>
            {% endif %}
          </dl>
        </div>

      </div>

      {# Ad summary data #}
      <table class="table table-hover">
        <thead>
          <tr>
            <th><strong>{% trans 'Day (UTC)' %}</strong></th>
            <th><strong>{% trans 'Views' %}</strong></th>
            <th><strong>{% trans 'Clicks' %}</strong></th>
            <th><strong>{% trans 'Cost' %}</strong></th>
            <th><strong>{% blocktrans %}<abbr title="Click through rate">CTR</abbr>{% endblocktrans %}</strong></th>
          </tr>
        </thead>
        {% for day in ad.report.days %}
          {% if day.views > 0 or day.clicks > 0 %}
          <tr>
            <td>{{ day.date }}</td>
            <td>{{ day.views|intcomma }}</td>
            <td>{{ day.clicks|intcomma }}</td>
            <td>${{ day.cost|floatformat:2|intcomma }}</td>
            <td>{{ day.ctr|floatformat:3 }}%</td>
          </tr>
          {% endif %}
        {% endfor %}
        <tfoot>
          <tr>
            <td><strong>{% trans 'Total' %}</strong> </td>
            <td><strong>{{ ad.report.total.views|intcomma }}</strong></td>
            <td><strong>{{ ad.report.total.clicks|intcomma }}</strong></td>
            <td><strong>${{ ad.report.total.cost|floatformat:2|intcomma }}</strong></td>
            <td><strong>{{ ad.report.total.ctr|floatformat:3 }}%</strong></td>
          </tr>
        </tfoot>
      </table>

    {% endfor %}{# // advertisements #}

  </section>
</div>
{% endblock report %}
