{% extends "adserver/staff/base.html" %}
{% load humanize %}
{% load i18n %}
{% load crispy_forms_tags %}


{% block title %}{% trans 'Publisher Payout' %} - {{ payout.publisher.slug }}{% endblock title %}

{% block breadcrumbs %}
  {{ block.super }}
  <li class="breadcrumb-item active">{% trans 'Publisher Payout' %} - {{ payout.publisher.slug }}</li>
{% endblock breadcrumbs %}


{% block content_container %}
<h1>{% block heading %}{% trans 'Finish Payout' %}{% endblock heading %}</h1>

<div>

<form method="post">

  <h5 class="mb-3">{% trans 'Payout Details' %}</h5>

  <dl>
    <dt>{% trans 'Publisher' %}</dt>
    <dd>{{ payout.publisher }}</dd>

    <dt>{% trans 'Method' %}</dt>
    <dd>
    {{ payout.publisher.get_payout_method_display }}:
    </dd>

    {% if payout.publisher.paypal_email %}
    <dt>{% trans 'User' %}</dt>
    <dd>
      <span id="payout-email">{{ payout.publisher.paypal_email }}</span>
      <button type="button" class="btn btn-sm btn-outline-secondary ml-2 copy-btn" data-copy-target="payout-email" title="{% trans 'Copy email' %}">
        <span class="fa fa-copy" aria-hidden="true"></span>
      </button>
    </dd>
    {% endif %}

    <dt>{% trans 'Status' %}</dt>
    <dd>{{ payout.get_status_display }}</dd>

    <dt>{% trans 'Amount' %}</dt>
    <dd>
      <span id="payout-amount">${{ payout.amount|floatformat:2|intcomma }}</span>
      <button type="button" class="btn btn-sm btn-outline-secondary ml-2 copy-btn" data-copy-target="payout-amount" title="{% trans 'Copy amount' %}">
        <span class="fa fa-copy" aria-hidden="true"></span>
      </button>
    </dd>

    <dt>{% trans 'Subject' %}</dt>
    <dd>
      <span id="payout-subject">{% trans "EthicalAds Payout" %} - {{ payout.publisher.name }}</span>
      <button type="button" class="btn btn-sm btn-outline-secondary ml-2 copy-btn" data-copy-target="payout-subject" title="{% trans 'Copy subject' %}">
        <span class="fa fa-copy" aria-hidden="true"></span>
      </button>
    </dd>

    <dt>{% trans 'Action' %}</dt>
    <dd>
      <div class="ml-2 mb-5">

        {% if payout.status == 'emailed' and payout.publisher.payout_url %}
          {% if payout.method == "stripe" %}
            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="stripe-payout-confirm" name="stripe-payout-confirm" checked="checked">
              <label class="form-check-label" for="stripe-payout-confirm">
                <span>{% blocktrans with amount=payout.amount|floatformat:2|intcomma %}Send ${{ amount }} via Stripe Connect{% endblocktrans %}</span>
              </label>
            </div>

            <a href="{{ payout.publisher.payout_url }}" class="btn btn-sm btn-outline-secondary">{% trans "Or Send Manually" %}</a>
          {% elif payout.method == "paypal" %}
            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="paypal-payout-confirm" name="paypal-payout-confirm">
              <label class="form-check-label" for="paypal-payout-confirm">
                <span>{% blocktrans with amount=payout.amount|floatformat:2|intcomma %}Send ${{ amount }} via PayPal ($0.25 fee){% endblocktrans %}</span>
              </label>
            </div>

            <a href="{{ payout.publisher.payout_url }}" class="btn btn-sm btn-outline-secondary">{% trans "Or Send Manually" %}</a>
          {% else %}
            <a href="{{ payout.publisher.payout_url }}" class="btn btn-sm btn-outline-secondary">{% trans "Send Money" %}</a>
          {% endif %}
        {% endif %}

      </div>
    </dd>

  </dl>

  {% csrf_token %}
  <input type="submit" value="{% trans "Finish payout" %}" class="btn btn-primary">
  <p class="small">{% trans "This will mark the payout as paid" %}</p>

</form>

</div>

<script>
  (function() {
    var RESET_TIMEOUT = 1500;

    // Function to copy text to clipboard
    function copyToClipboard(text, button, callback) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          callback();
        }).catch(function(err) {
          console.error('Failed to copy text: ', err);
          alert('Failed to copy to clipboard');
        });
      } else {
        // Fallback for older browsers
        var textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          callback();
        } catch (err) {
          console.error('Fallback: Failed to copy text: ', err);
          alert('Failed to copy to clipboard');
        }
        document.body.removeChild(textArea);
      }
    }

    // Function to show success feedback on button
    function showSuccessFeedback(button) {
      var icon = button.querySelector('.fa-copy');
      if (icon) {
        icon.classList.remove('fa-copy');
        icon.classList.add('fa-check');
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(function() {
          icon.classList.remove('fa-check');
          icon.classList.add('fa-copy');
          button.classList.remove('btn-success');
          button.classList.add('btn-outline-secondary');
        }, RESET_TIMEOUT);
      }
    }

    // Add click handlers to all copy buttons
    var copyButtons = document.querySelectorAll('.copy-btn');
    copyButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        var targetId = this.getAttribute('data-copy-target');
        var targetElement = document.getElementById(targetId);
        if (targetElement) {
          var textToCopy = targetElement.textContent.trim();
          copyToClipboard(textToCopy, this, function() {
            showSuccessFeedback(button);
          });
        }
      });
    });
  })();
</script>

{% endblock content_container %}
