{% extends "adserver/staff/base.html" %}
{% load humanize %}
{% load i18n %}
{% load crispy_forms_tags %}


{% block title %}{% trans 'Publisher Payout' %} - {{ payout.publisher.slug }}{% endblock title %}

{% block breadcrumbs %}
  {{ block.super }}
  <li class="breadcrumb-item active">{% trans 'Publisher Payout' %} - {{ payout.publisher.slug }}</li>
{% endblock breadcrumbs %}


{% block content_container %}
<h1>{% block heading %}{% trans 'Finish Payout' %}{% endblock heading %}</h1>

<div>

<form method="post">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <h5 class="mb-0">{% trans 'Payout Details' %}</h5>
    <button type="button" class="btn btn-sm btn-outline-primary" id="copy-payout-info" title="{% trans 'Copy payout information' %}">
      <span class="fa fa-copy mr-1" aria-hidden="true"></span>
      <span id="copy-btn-text">{% trans 'Copy Info' %}</span>
    </button>
  </div>

  <dl>
    <dt>{% trans 'Publisher' %}</dt>
    <dd>{{ payout.publisher }}</dd>

    <dt>{% trans 'Method' %}</dt>
    <dd>
    {{ payout.publisher.get_payout_method_display }}:
    </dd>

    {% if payout.publisher.paypal_email %}
    <dt>{% trans 'User' %}</dt>
    <dd id="payout-email">
    {{ payout.publisher.paypal_email }}
    </dd>
    {% endif %}

    <dt>{% trans 'Status' %}</dt>
    <dd>{{ payout.get_status_display }}</dd>

    <dt>{% trans 'Amount' %}</dt>
    <dd id="payout-amount">${{ payout.amount|floatformat:2|intcomma }}</dd>

    <dt>{% trans 'Subject' %}</dt>
    <dd id="payout-subject">{% trans "EthicalAds Payout" %} - {{ payout.publisher.name }}</dd>

    <dt>{% trans 'Action' %}</dt>
    <dd>
      <div class="ml-2 mb-5">

        {% if payout.status == 'emailed' and payout.publisher.payout_url %}
          {% if payout.method == "stripe" %}
            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="stripe-payout-confirm" name="stripe-payout-confirm" checked="checked">
              <label class="form-check-label" for="stripe-payout-confirm">
                <span>{% blocktrans with amount=payout.amount|floatformat:2|intcomma %}Send ${{ amount }} via Stripe Connect{% endblocktrans %}</span>
              </label>
            </div>

            <a href="{{ payout.publisher.payout_url }}" class="btn btn-sm btn-outline-secondary">{% trans "Or Send Manually" %}</a>
          {% elif payout.method == "paypal" %}
            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="paypal-payout-confirm" name="paypal-payout-confirm">
              <label class="form-check-label" for="paypal-payout-confirm">
                <span>{% blocktrans with amount=payout.amount|floatformat:2|intcomma %}Send ${{ amount }} via PayPal ($0.25 fee){% endblocktrans %}</span>
              </label>
            </div>

            <a href="{{ payout.publisher.payout_url }}" class="btn btn-sm btn-outline-secondary">{% trans "Or Send Manually" %}</a>
          {% else %}
            <a href="{{ payout.publisher.payout_url }}" class="btn btn-sm btn-outline-secondary">{% trans "Send Money" %}</a>
          {% endif %}
        {% endif %}

      </div>
    </dd>

  </dl>

  {% csrf_token %}
  <input type="submit" value="{% trans "Finish payout" %}" class="btn btn-primary">
  <p class="small">{% trans "This will mark the payout as paid" %}</p>

</form>

</div>

<script>
  (function() {
    document.getElementById('copy-payout-info').addEventListener('click', function() {
      // Get the payout information
      var amount = document.getElementById('payout-amount').textContent.trim();
      var subject = document.getElementById('payout-subject').textContent.trim();
      var emailElement = document.getElementById('payout-email');
      var email = emailElement ? emailElement.textContent.trim() : '';

      // Format the text to copy
      var textToCopy = 'Amount: ' + amount + '\n';
      if (email) {
        textToCopy += 'Email: ' + email + '\n';
      }
      textToCopy += 'Subject: ' + subject;

      // Copy to clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy).then(function() {
          // Show success feedback
          var btnText = document.getElementById('copy-btn-text');
          var originalText = btnText.textContent;
          btnText.textContent = '{% trans "Copied!" %}';
          
          setTimeout(function() {
            btnText.textContent = originalText;
          }, 2000);
        }).catch(function(err) {
          console.error('Failed to copy text: ', err);
          alert('Failed to copy to clipboard');
        });
      } else {
        // Fallback for older browsers
        var textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          var btnText = document.getElementById('copy-btn-text');
          var originalText = btnText.textContent;
          btnText.textContent = '{% trans "Copied!" %}';
          
          setTimeout(function() {
            btnText.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error('Fallback: Failed to copy text: ', err);
          alert('Failed to copy to clipboard');
        }
        document.body.removeChild(textArea);
      }
    });
  })();
</script>

{% endblock content_container %}
