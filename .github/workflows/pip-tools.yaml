# Action to run uv lock monthly and create a Pull Request with the changes.
# This keeps dependencies up-to-date by updating uv.lock with the latest
# compatible versions from pyproject.toml.

name: Update dependencies with uv

on:
  schedule:
    # Run monthly
    - cron: "0 0 1 * *"

permissions:
  contents: read

jobs:
  update-dependencies:
    permissions:
      contents: write # to create branch (peter-evans/create-pull-request)
      pull-requests: write # to create a PR (peter-evans/create-pull-request)

    name: Update dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install "pg_config" requirement
        run: sudo apt-get install libpq-dev

      - name: Update dependencies with uv lock
        run: uv lock --upgrade

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          add-paths: |
            uv.lock
          title: |
            Dependencies: all packages updated via uv lock
          body: |
            Dependencies: all packages updated via uv lock
            
            This PR updates the `uv.lock` file with the latest compatible versions
            of all dependencies specified in `pyproject.toml`.
          commit-message: |
            Dependencies: all packages updated via uv lock
          delete-branch: true
          branch: dependencies/uv-lock
          branch-suffix: short-commit-hash
